# Test Case For Kill All Transactions
--source include/no_protocol.inc
--source include/have_innodb.inc
--source include/not_embedded.inc

SET autocommit=0;
CREATE TABLE t1 (a INT) ENGINE=InnoDB;

SHOW VARIABLES LIKE 'idle_%transaction_timeout';
SET idle_transaction_timeout=1;
SHOW VARIABLES LIKE 'idle_%transaction_timeout';

BEGIN;
INSERT INTO t1 VALUES (1),(2),(3);
COMMIT;
SELECT * FROM t1;

BEGIN;
INSERT INTO t1 VALUES (4),(5),(6);
sleep 2;

--enable_reconnect
--error 2006,2013
SELECT * FROM t1;
SELECT * FROM t1;
DROP TABLE t1;
SET idle_transaction_timeout=0;
SHOW VARIABLES LIKE 'idle_%transaction_timeout';

# Test Case For Kill Read-Only Transaction
SET autocommit=0;
CREATE TABLE t1 (a INT) ENGINE=InnoDB;

SHOW VARIABLES LIKE 'idle_%transaction_timeout';
SET idle_readonly_transaction_timeout=1;
SHOW VARIABLES LIKE 'idle_%transaction_timeout';

BEGIN;
INSERT INTO t1 VALUES (1),(2),(3);
SELECT * FROM t1;
COMMIT;
SELECT * FROM t1;

sleep 2;

--enable_reconnect
--error 2006,2013
SELECT * FROM t1;
SELECT * FROM t1;
DROP TABLE t1;
SET idle_readonly_transaction_timeout=0;
SHOW VARIABLES LIKE 'idle_%transaction_timeout';

# Test Case For Kill Changes Transaction
SET autocommit=0;
CREATE TABLE t1 (a INT) ENGINE=InnoDB;

SHOW VARIABLES LIKE 'idle_%transaction_timeout';
SET idle_readwrite_transaction_timeout=1;
SHOW VARIABLES LIKE 'idle_%transaction_timeout';

BEGIN;
INSERT INTO t1 VALUES (1),(2),(3);
SELECT * FROM t1;
COMMIT;
SELECT * FROM t1;

sleep 2;

SELECT * FROM t1;
INSERT INTO t1 VALUES (4),(5),(6);
sleep 2;
--enable_reconnect
--error 2006,2013
SELECT * FROM t1;
DROP TABLE t1;
SET idle_readwrite_transaction_timeout=0;
SHOW VARIABLES LIKE 'idle_%transaction_timeout';
